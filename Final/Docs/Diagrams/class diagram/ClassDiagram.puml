@startuml
'skinparam classAttributeIconSize 0
scale 1.5
'left to right direction
skinparam linetype ortho


package BL {

	package JADE <<External library>> {

		abstract class Agent <<Abstract, JADE>> {
		    {abstract} #Setup() : void
		    addBehaviour(Behaviour b) : void
		}

		abstract class Behaviour <<Abstract, JADE>>
		Behaviour -- Agent

		class ACLMessage
	}

	package DataObjects{
		
		class Device {
			+name : String
			+subtype : String
			+location : String
		}

		class Sensor {
			+currState : double
			+sensingProperties : List<String>
			+change(double) : void
		}

		class Actuator {
			+actions : List<Action>
			+act(Sensors, Action) : void
		}

		class Effect {
			+property : String
			+delta : double
		}

		class Action {
			+name : String
			+powerConsumption : double
			+effects : List<Effect>
		}

		enum RelationType {
			EQ
			GEQ
			LEQ
			GT
			LT
		}

		enum Prefix {
			BEFORE
			AFTER
			AT
		}

		class Rule {
			+isActive : boolean
			+device : Device
			+property : String
			+ruleValue : double
			+prefixType : RelationType
			+relationValue : double
			+prefix : Prefix
		}

		class AgentData {
			+name : String
			+neighbors : List<AgentData>
			+backgroundLoad : double[Problem.horizon]
			+priceSchema : double[Problem.horizon]
			+houseType : int
			+rules : List<Rule>
			+actuators : List<Actuator>
			+sensors : List<Sensor>
		}

		class Problem {
			id : String
			allDevices : Map<Integer, List<Device>>
			allHomes : List<AgentData>
			horizon : int
			granularity : int
			priceScheme : double[horizon]
		}

		Device <|-- Sensor
		Device <|-- Actuator

		Actuator o-- Action
		Action o-- Effect

		Problem *-- AgentData
		AgentData o-- Sensor
		AgentData o-- Actuator
		AgentData o-down- AgentData
		AgentData o-- Rule

		Prefix <-- Rule
		RelationType <-- Rule
		Rule o-- Device
	}

	package Agents {

		class AlgorithmDataHelper {
			totalPriceConsumption : double
			+createNewProp() : PropertyWithData
			+buildNewPropertyData(Rule, boolean) : void
			+SetActuatorsAndSensors() : void
			+matchSensors(Action, PropertyWithData, boolean) : void
			+solve(int[], int, int, List<List<int>>) : void
			+{static} distinctByKey(Function) : Predicate
			+calcPriceSchemeForAllNeighbours() : void
			+calcHowLongDeviceNeedToWork(PropertyWithData) : double
			+updateConsumption(PropertyWithData, List<int>) : void
		}

		class PropertyWithData {
			+name : String
			+min : double
			+max : double
			+targetValue : double
			+actuator : Actuator
			+sensor : Sensor
			+isPassiveOnly : boolean
			+prefix : Prefix
			+rt : RelationType
			+targetTick : double
			+deltaWhenWork : double
			+powerConsumedInWork : double
			+deltaWhenWorkOffline : double
			+isLocation : boolean
			+relatedSensorsDelta : Map<String,Double>
			+relatedSensorsWhenWorkOfflineDelta : Map<String,Double>
			+canBeModified(double) : boolean
		}

		class SmartHomeAgent {
			+agentData : agentData
			+bestIteration : AgentIterationData
			+currIteration : AgentIterationData
			+numOfIterations : int
			#Setup() : void
			addBehaviour(Behaviour b) : void
		}

		Note "action(){\n\twhile(!stop){\n\t\t...\n\t\tdoIteration();\n\t\tsendIterationToCollector();\n\t\t..\n\t}\n}" as smabNote

		abstract class SmartHomeAgentBehaviour <<Abstract>> {
			+agent : SmartHomeAgent
			+name : String
			#helper : AlgorithmDataHelper
			#{abstract} doIteration() : void
			-sendIterationToCollector(AgentIterationData) : void
			-sendIterationToNeighbors() : void
			+{abstract} cloneBehaviour() : SmartHomeAgentBehaviour
			+waitForNeighbourMessages : List<ACLMessage>
			#parseMessages(List<ACLMessage>) : void
			#calcPrice(double[]) : double
			#initializeBehaviourWithAgent(SmartHomeAgent) : void
			#addBackgroundLoadToPriceScheme(double[]) : void
			+action() : void
			+done() : boolean
		}

		class DBA {
			+doIteration() : void
		}

		class DSA {
			+doIteration() : void
		}

		class Algo3 {
			+doIteration : void
		}

		class Algo4 {
			+doIteration() : void
		}


		Agent <|-- SmartHomeAgent
		SmartHomeAgentBehaviour --|> Behaviour
		SmartHomeAgent -- SmartHomeAgentBehaviour

		SmartHomeAgentBehaviour . smabNote

		Problem *-- Device

		SmartHomeAgentBehaviour <|-- DBA
		SmartHomeAgentBehaviour <|-- DSA
		SmartHomeAgentBehaviour <|-- Algo3
		SmartHomeAgentBehaviour <|-- Algo4

		DSA --> AlgorithmDataHelper
		DSA --> PropertyWithData

		AlgorithmDataHelper --> PropertyWithData
		AlgorithmDataHelper --> SmartHomeAgent


	}

	package IterationData {

		class AgentIterationData {
			+iterNum : int
			+agentName : String
			+price : double
			+powerConsumptionPerTick : double[]
		}

		class IterationCollectedData {

			+problemId : String
			+algorithm : String
		} 

		AgentIterationData <|-- IterationCollectedData
	}

	package DataCollection {

		class PowerConsumptionUtils <<Static>> {
			+{static} AE : double
			+{static} AC : double
			+{static} calculateCSum(List<double[]>, double[]) : double
			+{static} calculateTotalConsumptionWithPenalty(double, double[], double[], List<double[]>, double[]) : double
		}

		class DataCollector {
		    +numOfAgentsInProblems : Map<String, int>
		    +probAlgoToItAgentPrice : Map<ProblemAlgorithm, IterationAgentsPrice>
		    +probAlgoToResult : Map<ProblemAlgorithm, AlgorithmProblemResult>
		    +probToPriceScheme : Map<String, double[]>

		    +algorithmRunEnded() : void
		    +sendCSumToAgents(List<)
		    +addData(IterationCollectedData) : void    
		}

		class DataCollectionCommunicator {
			-dataCollector : DataCollector
			#setup() : void
		}

		class DataCollectionCommunicatorBehaviour {
		    +agent : DataCollectorCommunicator
			+action() : void
		}

		class StatisticsHandler {
			calculateAvg(List<double>) : double
			getStatisticalSignificance(...) : double
		}

		class AlgorithmProblemResult {
			+problem : String
			+algorithm : String
			+avgPricePerIteration : Map<int, double>
			+iterationsTillBestPrice : int
			+lowestCostInBestIteration : double
			+lowestCostForAgentInBestIteration : double
			+lowestCostForAgentInBestIterationAgentName : String
			+highestCostForAgentInBestIteration : double
			+highestCostInForAgentBestIterationAgentName : String
		}

		Note "calculateCSum(allHomesSchedule, powerScheme) {...}" as UtilsCSumNote
		Note "calculateEPeak(CSum, newSchedule, oldSchedule, otherSchedules, powerScheme) {...}" as UtilsEPeakNote

		DataCollector --o DataCollectionCommunicator
		DataCollector o-- IterationCollectedData
		DataCollectionCommunicatorBehaviour --|> Behaviour
		DataCollectionCommunicatorBehaviour --o DataCollectionCommunicator
		DataCollector --> StatisticsHandler
		
		DataCollector --> PowerConsumptionUtils

		PowerConsumptionUtils .. UtilsEPeakNote
		PowerConsumptionUtils .. UtilsCSumNote
	}

	interface ExperimentBuilderInterface {
		+addNumOfIterations(int) : void
		+addAlgorithms(List<String>) : void
		+addProblems(List<String>) : void
		+addService(Service) : void
		+create() : Experiment
	}

	class ExperimentBuilder {
		-numOfIterations : int
		-problems : List<Problem>
		-algos : List<SmartHomeAgentBehaviour>
		-service : Service

		+setNumOfIterations(int) : void
		+addAlgorithms(List<String>) : void
		+addProblems(List<String>) : void
		+createExperiment() : Experiment
	}

	interface ExperimentInterface {
		+runExperiment() : void
		+algorithmRunEnded(AlgorithmProblemResult) : void
		+stop() : void
	}

	class Experiment {
		+numOfIterations : int
		-service : Service
		-dataCollector : DataCollector
		-problems : List<Problem>
		-algorithms : List<SmartHomeAgentBehaviour>

		-algorithmProblemRunResults : List<AlgorithmProblemResult>
		+runExperiment() : void
		+algorithmRunEnded(AlgorithmProblemResult) : void
		+stopExperiment() : void
	}

	ExperimentInterface <|-- Experiment
	ExperimentBuilderInterface <|-- ExperimentBuilder

	ExperimentBuilder --> Experiment : creates
	Experiment o-- DataCollectorCommunicator
	Experiment *-- Problem
	SmartHomeAgent *- AgentData
	DataCollector --> AlgorithmProblemResult : create
	DataCollectionCommunicator --> Experiment

	Experiment o-- AlgorithmProblemResult

	DataCollectionCommunicator "1" -- "1...*" SmartHomeAgentBehaviour
	DataCollectionCommunicator --> AgentIterationData
	DataCollector --> AgentIterationData

	SmartHomeAgentBehaviour -> PowerConsumptionUtils
	SmartHomeAgent o- AgentIterationData

	PropertyWithData --> Actuator
	PropertyWithData --> Sensor
	PropertyWithData --> Prefix
	PropertyWithData --> RelationType
	AlgorithmDataHelper --> Actuator
	AlgorithmDataHelper --> Sensor
}

package PL {

	interface UiHandlerInterface {
		+notifyExperimentEnded(List<AlgorithmProblemResult>) : void
	}

	class UiHandler <<Observer>> {
		chartsCreator : ChartViewer
		service : Service
		-showMainScreen() : void
		-showResultsScreen() : void
		+notifyExperimentEnded(List<AlgorithmProblemResult>) : void

	}

	class ChartViewer {
		+createPricePerIterChart(Map<int, double>, String) : LineChart
		+nameToNumBarChart(Map<String, int>) : BarChart
	}

	Note "createPricePerIterChart(iterToPriceMap, algoName)" as chartNote

	UiHandler --> ChartViewer
	UiHandlerInterface <|-- UiHandler
	ChartViewer . chartNote
}

package DAL {

    interface FileSaverInterface {
    	+saveExpirimentResult(List<AlgorithmProblemResult>) : void
    }

	class ExcelHandler {
    	+saveExpirimentResult(List<AlgorithmProblemResult>) : void
	}

    interface JsonLoaderInterface {
        +loadDevices(String) : Map<int, List<Device>>
        +loadProblems(List<String>) : List<Problem>
        +getAllProblemNames() : List<String>
    }

	class JsonsLoader {
		+loadDevices(String) : Map<int, List<Device>>
        +loadProblems(List<String>) : List<Problem>
        +getAllProblemNames() : List<String>
	}

    interface AlgoLoaderInterface {
		+loadAlgorithms(List<String>) : SmartHomeAgentBehaviour
        +getAllAlgoNames() : List<String>
        +addAlgoToSystem(String, String) : void
    }

	class AlgorithmLoader {
		+loadAlgorithms(List<String>) : SmartHomeAgentBehaviour
        +getAllAlgoNames() : List<String>
        +addAlgoToSystem(String, String) : void
	}

    interface DataAccessControllerInterface {
        +getProblems(List<String>) : List<Problem>
        +getAvailableAlgorithms() : List<String>
        +getAlgorithms(List<String>) : List<SmartHomeAgentBehaviour>
        +addAlgorithmToSystem(String, String) : void
        +saveExpirimentResult(List<AlgorithmProblemResult>) : void
    }

	class DataAccessController {
		+getProblems(List<String>) : List<Problem>
		+getAvailableAlgorithms() : List<String>
		+getAlgorithms(List<String>) : List<SmartHomeAgentBehaviour>
		+addAlgorithmToSystem(String, String) : void
		+saveExpirimentResult(List<AlgorithmProblemResult>) : void
	}

	DataAccessController --> AlgoLoaderInterface
	DataAccessController --> JsonLoaderInterface
	DataAccessController --> FileSaverInterface

	JsonLoaderInterface <|-- JsonsLoader
	AlgoLoaderInterface <|-- AlgorithmLoader
	DataAccessControllerInterface <|-- DataAccessController
	FileSaverInterface <|-- ExcelHandler
}

interface ServiceInterface {
	+currExperiment : Experiment
	+addAlgorithmsToExperiment(List<String>, int) : void
	+addProblemsToExperiment(List<String>) : void
	+runExperimrent() : void
	+stopExperiment() : void
	+getExperimentResults() : List<AlgorithmProblemResult>
    +experimentEnded(List<AlgorithmProblemResult>) : void
    +saveExperimentResults(List<AlgorithmProblemResult>) : void
}

class Service <<Observable>> {
	-experimentBuilder : ExperimentBuilder
	-dalController : DataAccessControllerInterface
	+currExperiment : Experiment
	+addAlgorithmsToExperiment(List<SmartHomeAgentBehaviour>, int) : void
	+addProblemsToExperiment(List<Problem>) : void
	+runExperimrent() : void
	+stopExperiment() : void
	+getExperimentResults() : List<AlgorithmProblemResult>
    +experimentEnded(List<AlgorithmProblemResult>) : void
    +saveExperimentResults(List<AlgorithmProblemResult>) : void
}

Note "addAlgorithmsToExperiment(algoNames, numOfIterations){\n\t...\n\texperimentBuilder.addAlgorithms(algoNames);\n\ttexperimentBuilder.addNumOfIterations(numOfIterations);\n\t...\n}" as ServiceAddAlgoNote

ServiceInterface <|-- Service
Service .. ServiceAddAlgoNote

class SmartHomeAlgorithm <<Not Implemented>> {
	-doIteration() : void
}

'**********out of package connections:************
Service --> ExperimentInterface
Experiment --> Service
Service --> AlgorithmProblemResult
Service --> ExperimentBuilderInterface

JsonsLoader --> Device : creates >
JsonsLoader -> Problem : creates >
AlgorithmLoader --> SmartHomeAgentBehaviour : creates >
DataAccessController --> Problem
DataCollectionCommunicator --|> Agent

ExperimentBuilder --> DataAccessControllerInterface

ExcelHandler -> AlgorithmProblemResult : saves

SmartHomeAlgorithm --|> SmartHomeAgentBehaviour

UiHandler --> ServiceInterface
UiHandlerInterface <-- Service


@enduml